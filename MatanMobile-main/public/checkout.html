<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×©×œ×•× ×××•×‘×˜×— - Matan Mobile</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="header-container">
            <a href="index.html" class="logo">ğŸ“± Matan Mobile</a>
            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="×ª×¤×¨×™×˜">â˜°</button>
            <div class="nav-overlay" id="navOverlay"></div>
            <nav id="mainNav">
                <ul>
                    <li><a href="index.html">×‘×™×ª</a></li>
                    <li><a href="products.html">××•×¦×¨×™×</a></li>
                    <li><a href="cart.html" class="cart-icon">ğŸ›’ <span class="cart-badge" style="display: none;">0</span></a></li>
                </ul>
                <div class="mobile-auth" id="mobileAuth"></div>
            </nav>
            <div class="user-menu"></div>
        </div>
    </header>

    <main class="container checkout-page">
        <a href="cart.html" class="checkout-back">â† ×—×–×¨×” ×œ×¡×œ</a>
        <h1 class="page-title">×ª×©×œ×•× ×××•×‘×˜×—</h1>

        <div class="checkout-container">
            <!-- ×¡×™×›×•× ×”×–×× ×” -->
            <div class="checkout-summary">
                <h2>×¡×™×›×•× ×”×–×× ×”</h2>
                <div id="checkoutItems"></div>
                <div class="checkout-total">
                    <span>×¡×”"×› ×œ×ª×©×œ×•×</span>
                    <span id="checkoutTotal">â‚ª0</span>
                </div>
            </div>

            <!-- ×˜×•×¤×¡ ×ª×©×œ×•× - ×‘×¡×’× ×•×Ÿ Stripe -->
            <div class="checkout-form-card">
                <div class="payment-header">
                    <span class="payment-lock">ğŸ”’</span>
                    <h2>×¤×¨×˜×™ ×›×¨×˜×™×¡ ××©×¨××™</h2>
                    <p class="payment-subtitle">×”×ª×©×œ×•× ×××•×‘×˜×— ×•××¦×¤×™×Ÿ</p>
                </div>

                <form id="paymentForm" class="payment-form">
                    <div class="form-group">
                        <label for="cardNumber">××¡×¤×¨ ×›×¨×˜×™×¡</label>
                        <input type="text" id="cardNumber" name="cardNumber" 
                               placeholder="1234 5678 9012 3456" maxlength="19"
                               autocomplete="cc-number" inputmode="numeric">
                        <span class="card-icons">ğŸ’³</span>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="cardExpiry">×ª×•×§×£ (MM/YY)</label>
                            <input type="text" id="cardExpiry" name="cardExpiry" 
                                   placeholder="MM/YY" maxlength="5"
                                   autocomplete="cc-exp">
                        </div>
                        <div class="form-group">
                            <label for="cardCvc">×§×•×“ ××‘×˜×—×” (CVC)</label>
                            <input type="text" id="cardCvc" name="cardCvc" 
                                   placeholder="123" maxlength="4"
                                   autocomplete="cc-csc" inputmode="numeric">
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="cardName">×©× ×‘×¢×œ ×”×›×¨×˜×™×¡</label>
                        <input type="text" id="cardName" name="cardName" 
                               placeholder="×›×¤×™ ×©××•×¤×™×¢ ×¢×œ ×”×›×¨×˜×™×¡"
                               autocomplete="cc-name">
                    </div>

                    <div class="form-group">
                        <label for="billingAddress">×›×ª×•×‘×ª ×œ×—×™×•×‘ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="text" id="billingAddress" name="billingAddress" 
                               placeholder="×¨×—×•×‘, ×¢×™×¨, ××™×§×•×“">
                    </div>

                    <button type="submit" class="btn btn-primary btn-pay" id="payBtn">
                        <span class="btn-text">×©×œ× â‚ª<span id="payAmount">0</span></span>
                        <span class="btn-loading" style="display: none;">××¢×‘×“...</span>
                    </button>
                </form>

                <p class="payment-note">××¢×¨×›×ª ×ª×©×œ×•× Matan Pay - ×××•×‘×˜×—×ª ×•××¦×¤×™× ×”</p>
            </div>
        </div>
    </main>

    <footer>
        <div class="footer-bottom">
            <p>&copy; 2024 Matan Mobile. ×›×œ ×”×–×›×•×™×•×ª ×©××•×¨×•×ª.</p>
        </div>
    </footer>

    <script src="js/app.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('currentUser');
            const token = localStorage.getItem('authToken');
            if (!userStr || !token) {
                window.location.href = 'login.html?redirect=checkout.html';
                return;
            }

            const user = JSON.parse(userStr);
            initMobileMenu();
            loadUserFromStorage();
            updateCartBadge();

            const cartRes = await apiFetch(`/api/cart/${user.id}`);
            const cartData = await cartRes.json();

            if (!cartData.success || !cartData.data.items?.length) {
                document.querySelector('.checkout-container').innerHTML = `
                    <div class="empty-state">
                        <h2>×”×¡×œ ×©×œ×š ×¨×™×§</h2>
                        <p>×”×•×¡×£ ××•×¦×¨×™× ×œ×¡×œ ×œ×¤× ×™ ×‘×™×¦×•×¢ ×ª×©×œ×•×</p>
                        <a href="products.html" class="btn btn-primary">×¢×‘×•×¨ ×œ××•×¦×¨×™×</a>
                    </div>
                `;
                return;
            }

            const { items, total } = cartData.data;
            document.getElementById('checkoutItems').innerHTML = items.map(item => `
                <div class="checkout-item">
                    <span class="checkout-item-name">${item.product.title} Ã— ${item.quantity}</span>
                    <span class="checkout-item-price">â‚ª${(item.product.price * item.quantity).toLocaleString()}</span>
                </div>
            `).join('');

            document.getElementById('checkoutTotal').textContent = `â‚ª${total.toLocaleString()}`;
            document.getElementById('payAmount').textContent = total.toLocaleString();

            // ×¤×•×¨××˜ ××¡×¤×¨ ×›×¨×˜×™×¡
            document.getElementById('cardNumber').addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, '');
                v = v.replace(/(\d{4})(?=\d)/g, '$1 ');
                e.target.value = v.substring(0, 19);
            });

            // ×¤×•×¨××˜ ×ª×•×§×£ MM/YY
            document.getElementById('cardExpiry').addEventListener('input', function(e) {
                let v = e.target.value.replace(/\D/g, '');
                if (v.length >= 2) v = v.substring(0, 2) + '/' + v.substring(2, 4);
                e.target.value = v.substring(0, 5);
            });

            // CVC - ×¨×§ ×¡×¤×¨×•×ª
            document.getElementById('cardCvc').addEventListener('input', function(e) {
                e.target.value = e.target.value.replace(/\D/g, '').substring(0, 4);
            });

            document.getElementById('paymentForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const cardNumber = document.getElementById('cardNumber').value.replace(/\s/g, '');
                const cardExpiry = document.getElementById('cardExpiry').value;
                const cardCvc = document.getElementById('cardCvc').value;
                const cardName = document.getElementById('cardName').value.trim();
                const billingAddress = document.getElementById('billingAddress').value.trim();

                if (cardNumber.length < 13) {
                    showAlert('×”×–×Ÿ ××¡×¤×¨ ×›×¨×˜×™×¡ ×ª×§×™×Ÿ', 'error');
                    return;
                }
                if (!/^\d{2}\/\d{2}$/.test(cardExpiry)) {
                    showAlert('×”×–×Ÿ ×ª×•×§×£ ×›×¨×˜×™×¡ ×‘×¤×•×¨××˜ MM/YY', 'error');
                    return;
                }
                if (cardCvc.length < 3) {
                    showAlert('×”×–×Ÿ ×§×•×“ ××‘×˜×—×” (CVC)', 'error');
                    return;
                }
                if (!cardName) {
                    showAlert('×”×–×Ÿ ××ª ×©× ×‘×¢×œ ×”×›×¨×˜×™×¡', 'error');
                    return;
                }

                const btn = document.getElementById('payBtn');
                btn.disabled = true;
                btn.querySelector('.btn-text').style.display = 'none';
                btn.querySelector('.btn-loading').style.display = 'inline';

                try {
                    const userRes = await apiFetch(`/api/users/${user.id}`);
                    const userData = await userRes.json();
                    const address = billingAddress || (userData.success ? userData.data.address : '');

                    const res = await apiFetch(`/api/cart/${user.id}/checkout`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            address,
                            payment: {
                                last4: cardNumber.slice(-4),
                                brand: cardNumber.startsWith('4') ? 'Visa' : 'Mastercard'
                            }
                        })
                    });

                    const result = await res.json();

                    if (result.success) {
                        showAlert('×”×ª×©×œ×•× ×‘×•×¦×¢ ×‘×”×¦×œ×—×”!', 'success');
                        setTimeout(() => {
                            window.location.href = 'profile.html#profile-orders';
                        }, 1500);
                    } else {
                        showAlert(result.message || '×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×ª×©×œ×•×', 'error');
                        btn.disabled = false;
                        btn.querySelector('.btn-text').style.display = 'inline';
                        btn.querySelector('.btn-loading').style.display = 'none';
                    }
                } catch (err) {
                    showAlert('×©×’×™××” ×‘×‘×™×¦×•×¢ ×”×ª×©×œ×•×', 'error');
                    btn.disabled = false;
                    btn.querySelector('.btn-text').style.display = 'inline';
                    btn.querySelector('.btn-loading').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
