<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×œ×•×— ×‘×§×¨×” - Matan Mobile</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-layout { display: flex; gap: 24px; margin-top: 24px; }
        .admin-sidebar { width: 220px; flex-shrink: 0; }
        .admin-sidebar a { display: block; padding: 12px 16px; border-radius: 10px; color: var(--apple-black); text-decoration: none; margin-bottom: 4px; transition: background 0.2s; }
        .admin-sidebar a:hover, .admin-sidebar a.active { background: rgba(0,113,227,0.1); color: var(--apple-blue); }
        .admin-content { flex: 1; min-width: 0; }
        .admin-section { display: none; }
        .admin-section.active { display: block; }
        .admin-card { background: var(--apple-white); border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 12px rgba(0,0,0,0.06); }
        .admin-table { width: 100%; border-collapse: collapse; }
        .admin-table th, .admin-table td { padding: 12px; text-align: right; border-bottom: 1px solid var(--apple-gray-light); }
        .admin-table th { font-weight: 600; color: var(--apple-gray); font-size: 13px; }
        .admin-table img { width: 48px; height: 48px; object-fit: cover; border-radius: 8px; }
        .admin-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        .admin-actions .btn { padding: 6px 12px; font-size: 13px; }
        .admin-form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        @media (max-width: 768px) { .admin-layout { flex-direction: column; } .admin-sidebar { width: 100%; } .admin-form-grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <a href="index.html" class="logo">ğŸ“± Matan Mobile</a>
            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="×ª×¤×¨×™×˜">â˜°</button>
            <div class="nav-overlay" id="navOverlay"></div>
            <nav id="mainNav">
                <ul>
                    <li><a href="index.html">×‘×™×ª</a></li>
                    <li><a href="products.html">××•×¦×¨×™×</a></li>
                    <li><a href="profile.html">×¤×¨×•×¤×™×œ</a></li>
                </ul>
                <div class="mobile-auth" id="mobileAuth"></div>
            </nav>
            <div class="user-menu"></div>
        </div>
    </header>

    <main class="container">
        <h1 class="page-title">×œ×•×— ×‘×§×¨×” - ×× ×”×œ</h1>
        <div id="adminDenied" class="empty-state" style="display: none;">
            <h2>××™×Ÿ ×”×¨×©××•×ª ×’×™×©×”</h2>
            <p>×“×£ ×–×” ×–××™×Ÿ ×œ×× ×”×œ×™× ×‘×œ×‘×“.</p>
            <a href="profile.html" class="btn btn-primary">×—×–×¨×” ×œ×¤×¨×•×¤×™×œ</a>
        </div>

        <div id="adminContent" class="admin-layout" style="display: none;">
            <aside class="admin-sidebar">
                <a href="#" class="admin-nav" data-section="categories">ğŸ“ ×§×˜×’×•×¨×™×•×ª</a>
                <a href="#" class="admin-nav active" data-section="products">ğŸ“¦ ××•×¦×¨×™×</a>
                <a href="#" class="admin-nav" data-section="orders">ğŸ“‹ ×”×–×× ×•×ª</a>
                <a href="#" class="admin-nav" data-section="users">ğŸ‘¥ ××©×ª××©×™×</a>
            </aside>

            <div class="admin-content">
                <!-- ×§×˜×’×•×¨×™×•×ª -->
                <section id="section-categories" class="admin-section">
                    <div class="admin-card">
                        <h2>× ×™×”×•×œ ×§×˜×’×•×¨×™×•×ª</h2>
                        <form id="categoryForm" style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 20px;">
                            <div class="form-group" style="margin: 0;">
                                <label>×©× ×§×˜×’×•×¨×™×” (×¢×‘×¨×™×ª)</label>
                                <input type="text" id="categoryName" placeholder="×œ××©×œ: ×˜××‘×œ×˜×™×" required>
                            </div>
                            <div class="form-group" style="margin: 0;">
                                <label>×¢×¨×š (×× ×’×œ×™×ª, ×œ× ×—×•×‘×”)</label>
                                <input type="text" id="categoryValue" placeholder="tablets - ×™×•×•×¦×¨ ××•×˜×•××˜×™×ª">
                            </div>
                            <button type="submit" class="btn btn-primary">+ ×”×•×¡×£ ×§×˜×’×•×¨×™×”</button>
                        </form>
                        <div id="categoriesTable" style="overflow-x: auto;"></div>
                    </div>
                </section>

                <!-- ××•×¦×¨×™× -->
                <section id="section-products" class="admin-section active">
                    <div class="admin-card">
                        <h2>× ×™×”×•×œ ××•×¦×¨×™×</h2>
                        <button type="button" class="btn btn-primary" onclick="openProductModal()">+ ×”×•×¡×£ ××•×¦×¨</button>
                        <div id="productsTable" style="margin-top: 20px; overflow-x: auto;"></div>
                    </div>
                </section>

                <!-- ×”×–×× ×•×ª -->
                <section id="section-orders" class="admin-section">
                    <div class="admin-card">
                        <h2>×›×œ ×”×”×–×× ×•×ª</h2>
                        <div id="ordersTable" style="margin-top: 20px; overflow-x: auto;"></div>
                    </div>
                </section>

                <!-- ××©×ª××©×™× -->
                <section id="section-users" class="admin-section">
                    <div class="admin-card">
                        <h2>×›×œ ×”××©×ª××©×™×</h2>
                        <button type="button" class="btn btn-primary" onclick="openAddUserModal()" style="margin-bottom: 20px;">+ ×”×•×¡×£ ××©×ª××©</button>
                        <div id="usersTable" style="overflow-x: auto;"></div>
                    </div>
                </section>
            </div>
        </div>
    </main>

    <!-- ××•×“×œ ××•×¦×¨ -->
    <div id="productModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h2 id="productModalTitle">×”×•×¡×£ ××•×¦×¨</h2>
            <form id="productForm">
                <input type="hidden" id="productId">
                <div class="form-group"><label>×©× ××•×¦×¨</label><input type="text" id="productTitle" required></div>
                <div class="form-group"><label>××—×™×¨ (â‚ª)</label><input type="number" id="productPrice" required min="0"></div>
                <div class="form-group"><label>×ª×™××•×¨</label><textarea id="productDescription" rows="2"></textarea></div>
                <div class="admin-form-grid">
                    <div class="form-group"><label>×§×˜×’×•×¨×™×”</label>
                        <select id="productCategory"><option value="smartphones">×¡×××¨×˜×¤×•× ×™×</option><option value="accessories">××‘×™×–×¨×™×</option></select>
                    </div>
                    <div class="form-group"><label>××•×ª×’</label><input type="text" id="productBrand" placeholder="Apple, Samsung..."></div>
                </div>
                <div class="admin-form-grid">
                    <div class="form-group"><label>×“×’×</label><input type="text" id="productModel"></div>
                    <div class="form-group"><label>××œ××™</label><input type="number" id="productStock" min="0" value="0"></div>
                </div>
                <div class="form-group">
                    <label>×§×™×©×•×¨ ×œ×ª××•× ×”</label>
                    <input type="url" id="productImage" placeholder="https://...">
                </div>
                <div class="form-group" style="margin-top: 16px;">
                    <button type="submit" class="btn btn-primary">×©××•×¨</button>
                    <button type="button" class="btn btn-secondary" onclick="closeProductModal()">×‘×™×˜×•×œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ××•×“×œ ×¢×¨×™×›×ª ×”×–×× ×” -->
    <div id="orderModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2>×¢×¨×™×›×ª ×”×–×× ×”</h2>
            <div id="orderModalBody"></div>
            <div class="form-group"><label>×¡×˜×˜×•×¡</label>
                <select id="orderStatus">
                    <option value="pending">×××ª×™× ×”</option>
                    <option value="completed">×”×•×©×œ××”</option>
                    <option value="cancelled">×‘×•×˜×œ×”</option>
                </select>
            </div>
            <div class="form-group"><label>×›×ª×•×‘×ª</label><input type="text" id="orderAddress"></div>
            <button type="button" class="btn btn-primary" onclick="saveOrderEdit()">×©××•×¨</button>
            <button type="button" class="btn btn-secondary" onclick="closeOrderModal()">×¡×’×•×¨</button>
        </div>
    </div>

    <!-- ××•×“×œ ×¢×¨×™×›×ª ××©×ª××© -->
    <div id="userModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2>×¢×¨×™×›×ª ××©×ª××©</h2>
            <input type="hidden" id="editUserId">
            <div class="form-group"><label>×©× ×¤×¨×˜×™</label><input type="text" id="editUserFirstName"></div>
            <div class="form-group"><label>×©× ××©×¤×—×”</label><input type="text" id="editUserLastName"></div>
            <div class="form-group"><label>××™××™×™×œ</label><input type="email" id="editUserEmail" readonly style="background:#f5f5f5"></div>
            <div class="form-group"><label>×˜×œ×¤×•×Ÿ</label><input type="tel" id="editUserPhone"></div>
            <div class="form-group"><label>×›×ª×•×‘×ª</label><input type="text" id="editUserAddress"></div>
            <button type="button" class="btn btn-primary" onclick="saveUserEdit()">×©××•×¨</button>
            <button type="button" class="btn btn-secondary" onclick="closeUserModal()">×¡×’×•×¨</button>
        </div>
    </div>

    <!-- ××•×“×œ ×”×•×¡×¤×ª ××©×ª××© -->
    <div id="addUserModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <h2>×”×•×¡×¤×ª ××©×ª××©</h2>
            <form id="addUserForm">
                <div class="form-group"><label>××™××™×™×œ *</label><input type="email" id="newUserEmail" required></div>
                <div class="form-group"><label>×¡×™×¡××” *</label><input type="password" id="newUserPassword" required></div>
                <div class="form-group"><label>×©× ×¤×¨×˜×™</label><input type="text" id="newUserFirstName"></div>
                <div class="form-group"><label>×©× ××©×¤×—×”</label><input type="text" id="newUserLastName"></div>
                <div class="form-group"><label>×˜×œ×¤×•×Ÿ</label><input type="tel" id="newUserPhone"></div>
                <div class="form-group"><label><input type="checkbox" id="newUserIsAdmin"> ×× ×”×œ</label></div>
                <button type="submit" class="btn btn-primary">×”×•×¡×£ ××©×ª××©</button>
                <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">×‘×™×˜×•×œ</button>
            </form>
        </div>
    </div>

    <!-- ××•×“×œ ×¦×¤×™×™×” ×‘×¡×™×¡××” -->
    <div id="viewPasswordModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 450px;">
            <h2>×¦×¤×™×™×” ×‘×¡×™×¡××”</h2>
            <p id="viewPasswordUserName" style="margin-bottom: 16px;"></p>
            <div class="form-group"><label>×”×–×Ÿ ××ª ×¡×™×¡××ª ×”×× ×”×œ ×œ××™××•×ª:</label><input type="password" id="adminPasswordForView" placeholder="×¡×™×¡××ª ×”×× ×”×œ"></div>
            <div id="viewPasswordResult" style="display: none; margin: 16px 0; padding: 12px; background: #f5f5f5; border-radius: 8px; font-family: monospace;"></div>
            <button type="button" class="btn btn-primary" onclick="submitViewPassword()">××™××•×ª ×•×¦×¤×™×™×”</button>
            <button type="button" class="btn btn-secondary" onclick="closeViewPasswordModal()">×¡×’×•×¨</button>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script>
        let adminUser = null;
        let currentOrderId = null;

        document.addEventListener('DOMContentLoaded', async () => {
            const userStr = localStorage.getItem('currentUser');
            const token = localStorage.getItem('authToken');
            if (!userStr || !token) {
                window.location.href = 'login.html?redirect=admin.html';
                return;
            }
            const user = JSON.parse(userStr);
            const res = await apiFetch(`/api/users/${user.id}`);
            const data = await res.json();
            if (!data.success || (!data.data.isAdmin && data.data.email !== 'admin@matan.com')) {
                document.getElementById('adminDenied').style.display = 'block';
                return;
            }
            adminUser = data.data;
            document.getElementById('adminContent').style.display = 'flex';
            loadUserFromStorage();

            document.querySelectorAll('.admin-nav').forEach(a => {
                a.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.querySelectorAll('.admin-nav').forEach(x => x.classList.remove('active'));
                    document.querySelectorAll('.admin-section').forEach(x => x.classList.remove('active'));
                    a.classList.add('active');
                    document.getElementById('section-' + a.dataset.section).classList.add('active');
                    if (a.dataset.section === 'categories') loadCategories();
                    if (a.dataset.section === 'products') loadProducts();
                    if (a.dataset.section === 'orders') loadOrders();
                    if (a.dataset.section === 'users') loadUsers();
                });
            });

            document.getElementById('productForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = document.getElementById('productId').value;
                const payload = {
                    title: document.getElementById('productTitle').value,
                    price: parseFloat(document.getElementById('productPrice').value),
                    description: document.getElementById('productDescription').value,
                    category: document.getElementById('productCategory').value,
                    brand: document.getElementById('productBrand').value,
                    model: document.getElementById('productModel').value,
                    stock: parseInt(document.getElementById('productStock').value) || 0,
                    image: document.getElementById('productImage').value || ''
                };
                try {
                    const url = id ? `/api/admin/products/${id}` : '/api/admin/products';
                    const method = id ? 'PUT' : 'POST';
                    const r = await apiFetch(url, {
                        method,
                        headers: apiHeaders(),
                        body: JSON.stringify(payload)
                    });
                    const result = await r.json();
                    if (result.success) {
                        showAlert(id ? '×”××•×¦×¨ ×¢×•×“×›×Ÿ' : '×”××•×¦×¨ × ×•×¡×£', 'success');
                        closeProductModal();
                        loadProducts();
                    } else showAlert(result.message || '×©×’×™××”', 'error');
                } catch (e) { showAlert('×©×’×™××”', 'error'); }
            });

            document.getElementById('categoryForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('categoryName').value.trim();
                const value = document.getElementById('categoryValue').value.trim();
                try {
                    const r = await apiFetch('/api/admin/categories', {
                        method: 'POST',
                        headers: apiHeaders(),
                        body: JSON.stringify({ name, value: value || undefined })
                    });
                    const data = await r.json();
                    if (data.success) {
                        showAlert('×”×§×˜×’×•×¨×™×” × ×•×¡×¤×”', 'success');
                        document.getElementById('categoryName').value = '';
                        document.getElementById('categoryValue').value = '';
                        loadCategories();
                        loadCategoriesForProduct();
                    } else showAlert(data.message || '×©×’×™××”', 'error');
                } catch (e) { showAlert('×©×’×™××”', 'error'); }
            });

            loadCategoriesForProduct();
            loadProducts();
        });

        function apiHeaders() {
            return { 'Content-Type': 'application/json' };
        }

        async function loadCategoriesForProduct() {
            const r = await apiFetch('/api/admin/categories');
            const data = await r.json();
            const list = data.success && data.data?.length ? data.data : [
                { name: '×¡×××¨×˜×¤×•× ×™×', value: 'smartphones' },
                { name: '××‘×™×–×¨×™×', value: 'accessories' }
            ];
            window.adminCategories = list;
            const sel = document.getElementById('productCategory');
            if (sel) sel.innerHTML = list.map(c => `<option value="${c.value}">${c.name}</option>`).join('');
        }

        async function loadCategories() {
            const r = await apiFetch('/api/admin/categories');
            const data = await r.json();
            const t = document.getElementById('categoriesTable');
            if (!data.success) { t.innerHTML = '<p>×©×’×™××” ×‘×˜×¢×™× ×”</p>'; return; }
            const list = data.data || [];
            window.adminCategories = list;
            t.innerHTML = list.length ? `
                <table class="admin-table">
                    <thead><tr><th>×©×</th><th>×¢×¨×š</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                    <tbody>${list.map(c => `
                        <tr>
                            <td>${c.name}</td>
                            <td><code>${c.value}</code></td>
                            <td><button class="btn btn-danger btn-sm" onclick="deleteCategory(${c.id})">××—×§</button></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>××™×Ÿ ×§×˜×’×•×¨×™×•×ª. ×”×•×¡×£ ×§×˜×’×•×¨×™×” ×—×“×©×”.</p>';
        }

        async function deleteCategory(id) {
            if (!confirm('×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×”? ××•×¦×¨×™× ×‘×§×˜×’×•×¨×™×” ×–×• ×™×©××¨×• ×¢× ×”×¢×¨×š ×”×™×©×Ÿ.')) return;
            const r = await apiFetch(`/api/admin/categories/${id}`, { method: 'DELETE', headers: apiHeaders() });
            const data = await r.json();
            if (data.success) { showAlert('×”×§×˜×’×•×¨×™×” × ××—×§×”', 'success'); loadCategories(); loadCategoriesForProduct(); }
            else showAlert(data.message || '×©×’×™××”', 'error');
        }

        async function loadProducts() {
            const r = await apiFetch('/api/admin/products');
            const data = await r.json();
            const t = document.getElementById('productsTable');
            if (!data.success) { t.innerHTML = '<p>×©×’×™××” ×‘×˜×¢×™× ×”</p>'; return; }
            const list = data.data || [];
            t.innerHTML = list.length ? `
                <table class="admin-table">
                    <thead><tr><th>×ª××•× ×”</th><th>×©×</th><th>××—×™×¨</th><th>×§×˜×’×•×¨×™×”</th><th>××œ××™</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                    <tbody>${list.map(p => `
                        <tr>
                            <td><img src="${p.image || 'https://via.placeholder.com/48'}" alt=""></td>
                            <td>${p.title}</td>
                            <td>â‚ª${(p.price||0).toLocaleString()}</td>
                            <td>${(window.adminCategories || []).find(c=>c.value===p.category)?.name || p.category}</td>
                            <td>${p.stock || 0}</td>
                            <td><div class="admin-actions">
                                <button class="btn btn-secondary btn-sm" onclick="editProduct(${p.id})">×¢×¨×•×š</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteProduct(${p.id})">××—×§</button>
                            </div></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>××™×Ÿ ××•×¦×¨×™×</p>';
        }

        function openProductModal(product) {
            document.getElementById('productModalTitle').textContent = product ? '×¢×¨×™×›×ª ××•×¦×¨' : '×”×•×¡×£ ××•×¦×¨';
            document.getElementById('productId').value = product ? product.id : '';
            document.getElementById('productTitle').value = product?.title || '';
            document.getElementById('productPrice').value = product?.price || '';
            document.getElementById('productDescription').value = product?.description || '';
            document.getElementById('productCategory').value = product?.category || 'smartphones';
            document.getElementById('productBrand').value = product?.brand || '';
            document.getElementById('productModel').value = product?.model || '';
            document.getElementById('productStock').value = product?.stock ?? 0;
            document.getElementById('productImage').value = product?.image || '';
            document.getElementById('productModal').style.display = 'flex';
        }

        async function editProduct(id) {
            const r = await fetch(`/api/products/${id}`);
            const data = await r.json();
            if (data.success) openProductModal(data.data);
        }

        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        async function deleteProduct(id) {
            if (!confirm('×œ××—×•×§ ××ª ×”××•×¦×¨?')) return;
            const r = await apiFetch(`/api/admin/products/${id}`, { method: 'DELETE', headers: apiHeaders() });
            const data = await r.json();
            if (data.success) { showAlert('×”××•×¦×¨ × ××—×§', 'success'); loadProducts(); }
            else showAlert(data.message || '×©×’×™××”', 'error');
        }

        async function loadOrders() {
            const r = await apiFetch('/api/admin/orders');
            const data = await r.json();
            const t = document.getElementById('ordersTable');
            if (!data.success) { t.innerHTML = '<p>×©×’×™××” ×‘×˜×¢×™× ×”</p>'; return; }
            const list = data.data || [];
            const statusLabels = { pending: '×××ª×™× ×”', completed: '×”×•×©×œ××”', cancelled: '×‘×•×˜×œ×”' };
            t.innerHTML = list.length ? `
                <table class="admin-table">
                    <thead><tr><th>#</th><th>×ª××¨×™×š</th><th>×¤×¨×™×˜×™×</th><th>×¡×”"×›</th><th>×¡×˜×˜×•×¡</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                    <tbody>${list.map(o => `
                        <tr>
                            <td>${o.id}</td>
                            <td>${new Date(o.createdAt).toLocaleDateString('he-IL')}</td>
                            <td>${(o.items||[]).map(i=>i.title).join(', ')}</td>
                            <td>â‚ª${(o.total||0).toLocaleString()}</td>
                            <td>${statusLabels[o.status] || o.status}</td>
                            <td><button class="btn btn-secondary btn-sm" onclick="editOrder(${o.id})">×¢×¨×•×š</button></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>××™×Ÿ ×”×–×× ×•×ª</p>';
        }

        async function editOrder(id) {
            currentOrderId = id;
            const r = await apiFetch(`/api/admin/orders/${id}`);
            const data = await r.json();
            if (!data.success) { showAlert('×”×–×× ×” ×œ× × ××¦××”', 'error'); return; }
            const o = data.data;
            document.getElementById('orderModalBody').innerHTML = `
                <p><strong>×”×–×× ×” #${o.id}</strong></p>
                <p>${(o.items||[]).map(i=>`${i.title} Ã— ${i.quantity}`).join('<br>')}</p>
                <p>×¡×”"×›: â‚ª${(o.total||0).toLocaleString()}</p>
            `;
            document.getElementById('orderStatus').value = o.status || 'pending';
            document.getElementById('orderAddress').value = o.address || '';
            document.getElementById('orderModal').style.display = 'flex';
        }

        async function saveOrderEdit() {
            const r = await apiFetch(`/api/admin/orders/${currentOrderId}`, {
                method: 'PATCH',
                headers: apiHeaders(),
                body: JSON.stringify({
                    status: document.getElementById('orderStatus').value,
                    address: document.getElementById('orderAddress').value
                })
            });
            const data = await r.json();
            if (data.success) { showAlert('×”×”×–×× ×” ×¢×•×“×›× ×”', 'success'); closeOrderModal(); loadOrders(); }
            else showAlert(data.message || '×©×’×™××”', 'error');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').style.display = 'none';
        }

        async function loadUsers() {
            const r = await apiFetch('/api/admin/users');
            const data = await r.json();
            const t = document.getElementById('usersTable');
            if (!data.success) { t.innerHTML = '<p>×©×’×™××” ×‘×˜×¢×™× ×”</p>'; return; }
            const list = data.data || [];
            t.innerHTML = list.length ? `
                <table class="admin-table">
                    <thead><tr><th>×©×</th><th>××™××™×™×œ</th><th>×˜×œ×¤×•×Ÿ</th><th>×× ×”×œ</th><th>×¤×¢×•×œ×•×ª</th></tr></thead>
                    <tbody>${list.map(u => `
                        <tr>
                            <td>${u.firstName || ''} ${u.lastName || ''}</td>
                            <td>${u.email || ''}</td>
                            <td>${u.phone || ''}</td>
                            <td>${u.isAdmin ? 'âœ“' : ''}</td>
                            <td><div class="admin-actions">
                                <button class="btn btn-secondary btn-sm" data-user-id="${u.id}" data-user-email="${u.email||''}" onclick="viewUserPassword(this)">×¦×¤×” ×‘×¡×™×¡××”</button>
                                <button class="btn btn-secondary btn-sm" onclick="editUser('${u.id}')">×¢×¨×•×š</button>
                                ${u.id !== adminUser.id ? `<button class="btn btn-danger btn-sm" onclick="deleteUser('${u.id}')">××—×§</button>` : ''}
                            </div></td>
                        </tr>
                    `).join('')}</tbody>
                </table>
            ` : '<p>××™×Ÿ ××©×ª××©×™×</p>';
        }

        function editUser(id) {
            apiFetch(`/api/users/${id}`).then(r=>r.json()).then(data=>{
                if (!data.success) return;
                const u = data.data;
                document.getElementById('editUserId').value = u.id;
                document.getElementById('editUserFirstName').value = u.firstName || '';
                document.getElementById('editUserLastName').value = u.lastName || '';
                document.getElementById('editUserEmail').value = u.email || '';
                document.getElementById('editUserPhone').value = u.phone || '';
                document.getElementById('editUserAddress').value = u.address || '';
                document.getElementById('userModal').style.display = 'flex';
            });
        }

        async function saveUserEdit() {
            const id = document.getElementById('editUserId').value;
            const r = await apiFetch(`/api/admin/users/${id}`, {
                method: 'PUT',
                headers: apiHeaders(),
                body: JSON.stringify({
                    firstName: document.getElementById('editUserFirstName').value,
                    lastName: document.getElementById('editUserLastName').value,
                    phone: document.getElementById('editUserPhone').value,
                    address: document.getElementById('editUserAddress').value
                })
            });
            const data = await r.json();
            if (data.success) { showAlert('×”××©×ª××© ×¢×•×“×›×Ÿ', 'success'); closeUserModal(); loadUsers(); }
            else showAlert(data.message || '×©×’×™××”', 'error');
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        async function deleteUser(id) {
            if (!confirm('×œ××—×•×§ ××ª ×”××©×ª××©?')) return;
            const r = await apiFetch(`/api/admin/users/${id}`, { method: 'DELETE', headers: apiHeaders() });
            const data = await r.json();
            if (data.success) { showAlert('×”××©×ª××© × ××—×§', 'success'); loadUsers(); }
            else showAlert(data.message || '×©×’×™××”', 'error');
        }

        function openAddUserModal() {
            document.getElementById('addUserForm').reset();
            document.getElementById('addUserModal').style.display = 'flex';
        }

        function closeAddUserModal() {
            document.getElementById('addUserModal').style.display = 'none';
        }

        document.getElementById('addUserForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const payload = {
                email: document.getElementById('newUserEmail').value.trim(),
                password: document.getElementById('newUserPassword').value,
                firstName: document.getElementById('newUserFirstName').value.trim(),
                lastName: document.getElementById('newUserLastName').value.trim(),
                phone: document.getElementById('newUserPhone').value.trim(),
                isAdmin: document.getElementById('newUserIsAdmin').checked
            };
            try {
                const r = await apiFetch('/api/admin/users', {
                    method: 'POST',
                    headers: apiHeaders(),
                    body: JSON.stringify(payload)
                });
                const data = await r.json();
                if (data.success) {
                    showAlert('×”××©×ª××© × ×•×¡×£', 'success');
                    closeAddUserModal();
                    loadUsers();
                } else showAlert(data.message || '×©×’×™××”', 'error');
            } catch (e) { showAlert('×©×’×™××”', 'error'); }
        });

        let viewPasswordUserId = null;
        function viewUserPassword(btn) {
            viewPasswordUserId = btn.dataset.userId;
            const email = btn.dataset.userEmail || '';
            document.getElementById('viewPasswordUserName').textContent = '××©×ª××©: ' + email;
            document.getElementById('adminPasswordForView').value = '';
            document.getElementById('viewPasswordResult').style.display = 'none';
            document.getElementById('viewPasswordResult').textContent = '';
            document.getElementById('viewPasswordModal').style.display = 'flex';
        }

        async function submitViewPassword() {
            const adminPass = document.getElementById('adminPasswordForView').value;
            if (!adminPass) { showAlert('×”×–×Ÿ ××ª ×¡×™×¡××ª ×”×× ×”×œ', 'error'); return; }
            try {
                const r = await apiFetch(`/api/admin/users/${viewPasswordUserId}/view-password`, {
                    method: 'POST',
                    headers: apiHeaders(),
                    body: JSON.stringify({ adminPassword: adminPass })
                });
                const data = await r.json();
                if (data.success) {
                    document.getElementById('viewPasswordResult').textContent = '×¡×™×¡××”: ' + data.data.password;
                    document.getElementById('viewPasswordResult').style.display = 'block';
                } else showAlert(data.message || '×¡×™×¡××ª ×”×× ×”×œ ×©×’×•×™×”', 'error');
            } catch (e) { showAlert('×©×’×™××”', 'error'); }
        }

        function closeViewPasswordModal() {
            document.getElementById('viewPasswordModal').style.display = 'none';
        }
    </script>
</body>
</html>
